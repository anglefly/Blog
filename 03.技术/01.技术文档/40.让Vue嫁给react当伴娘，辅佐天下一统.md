---
title: è®©Vueå«ç»™reactå½“ä¼´å¨˜ï¼Œè¾…ä½å¤©ä¸‹ä¸€ç»Ÿ
categories:
  - æŠ€æœ¯
  - æŠ€æœ¯æ–‡æ¡£
tags:
  -
---

# è®©Vueå«ç»™reactå½“ä¼´å¨˜ï¼Œè¾…ä½å¤©ä¸‹ä¸€ç»Ÿ

>`vue-next`æ˜¯`Vue3`çš„æºç ä»“åº“ï¼Œ`Vue3`é‡‡ç”¨`lerna`åš`package`çš„åˆ’åˆ†ï¼Œè€Œå“åº”å¼èƒ½åŠ›`@vue/reactivity`è¢«åˆ’åˆ†åˆ°äº†å•ç‹¬çš„ä¸€ä¸ª`package`ä¸­ã€‚
>
>å¦‚æœæˆ‘ä»¬æƒ³æŠŠå®ƒé›†æˆåˆ°`React`ä¸­ï¼Œå¯è¡Œå—ï¼Ÿæ¥è¯•ä¸€è¯•å§ã€‚

## ä½¿ç”¨ç¤ºä¾‹

è¯ä¸å¤šè¯´ï¼Œå…ˆçœ‹çœ‹æ€ä¹ˆç”¨çš„è§£è§£é¦‹å§ã€‚

```js
// store.ts
import { reactive, computed, effect } from '@vue/reactivity';

export const state = reactive({
  count: 0,
});

const plusOne = computed(() => state.count + 1);

effect(() => {
  console.log('plusOne changed: ', plusOne);
});

const add = () => (state.count += 1);

export const mutations = {
  // mutation
  add,
};

export const store = {
  state,
  computed: {
    plusOne,
  },
};

export type Store = typeof store;
// Index.tsx
import { Provider, useStore } from 'rxv'
import { mutations, store, Store } from './store.ts'
function Count() {
  const countState = useStore((store: Store) => {
    const { state, computed } = store;
    const { count } = state;
    const { plusOne } = computed;

    return {
      count,
      plusOne,
    };
  });

  return (
    <Card hoverable style={{ marginBottom: 24 }}>
      <h1>è®¡æ•°å™¨</h1>
      <div className="chunk">
        <div className="chunk">storeä¸­çš„countç°åœ¨æ˜¯ {countState.count}</div>
        <div className="chunk">computedå€¼ä¸­çš„plusOneç°åœ¨æ˜¯ {countState.plusOne.value}</div>
         <Button onClick={mutations.add}>add</Button>
      </div>
    </Card>
  );
}

export default () => {
  return (
    <Provider value={store}>
       <Count />
    </Provider>
  );
};
```

å¯ä»¥çœ‹å‡ºï¼Œ`store`çš„å®šä¹‰åªç”¨åˆ°äº†`@vue/reactivity`ï¼Œè€Œ`rxv`åªæ˜¯åœ¨ç»„ä»¶ä¸­åšäº†ä¸€å±‚æ¡¥æ¥ï¼Œè¿é€šäº†`Vue3`å’Œ`React`ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥å°½æƒ…çš„ä½¿ç”¨`Vue3`çš„å“åº”å¼èƒ½åŠ›å•¦ã€‚

## åˆ†æ

ä»è¿™ä¸ªåŒ…æä¾›çš„å‡ ä¸ªæ ¸å¿ƒ`api`æ¥åˆ†æï¼š

### `effect`ï¼ˆé‡ç‚¹ï¼‰

`effect`å…¶å®æ˜¯å“åº”å¼åº“ä¸­ä¸€ä¸ªé€šç”¨çš„æ¦‚å¿µï¼šè§‚å¯Ÿå‡½æ•°ï¼Œå°±åƒ`Vue2`ä¸­çš„`Watcher`ï¼Œ`mobx`ä¸­çš„`autorun`ï¼Œ`observer`ä¸€æ ·ï¼Œå®ƒçš„ä½œç”¨æ˜¯æ”¶é›†ä¾èµ–ã€‚

å®ƒæ¥å—çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä¼šå¸®ä½ æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”å¼€å¯ä¾èµ–æ”¶é›†ï¼Œ

è¿™ä¸ªå‡½æ•°å†…éƒ¨å¯¹äºå“åº”å¼æ•°æ®çš„è®¿é—®éƒ½å¯ä»¥æ”¶é›†ä¾èµ–ï¼Œé‚£ä¹ˆåœ¨å“åº”å¼æ•°æ®è¢«ä¿®æ”¹åï¼Œå°±ä¼šè§¦å‘æ›´æ–°ã€‚

æœ€ç®€å•çš„ç”¨æ³•

```js
const data = reactive({ count: 0 })
effect(() => {
    // å°±æ˜¯è¿™å¥è¯ è®¿é—®äº†data.count
    // ä»è€Œæ”¶é›†åˆ°äº†ä¾èµ–
    console.log(data.count)
})

data.count = 1
// æ§åˆ¶å°æ‰“å°å‡º1
```

é‚£ä¹ˆå¦‚æœæŠŠè¿™ä¸ªç®€å•ä¾‹å­ä¸­çš„

```js
() => {
    // å°±æ˜¯è¿™å¥è¯ è®¿é—®äº†data.count
    // ä»è€Œæ”¶é›†åˆ°äº†ä¾èµ–
    console.log(data.count)
}
```

è¿™ä¸ªå‡½æ•°ï¼Œæ›¿æ¢æˆ`React`çš„ç»„ä»¶æ¸²æŸ“ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½è¾¾æˆå“åº”å¼æ›´æ–°ç»„ä»¶çš„ç›®çš„äº†ï¼Ÿ

### `reactive`ï¼ˆé‡ç‚¹ï¼‰

å“åº”å¼æ•°æ®çš„æ ¸å¿ƒ`api`ï¼Œè¿™ä¸ª`api`è¿”å›çš„æ˜¯ä¸€ä¸ª`proxy`ï¼Œå¯¹ä¸Šé¢æ‰€æœ‰å±æ€§çš„è®¿é—®éƒ½ä¼šè¢«åŠ«æŒï¼Œä»è€Œåœ¨`get`çš„æ—¶å€™æ”¶é›†ä¾èµ–ï¼ˆä¹Ÿå°±æ˜¯æ­£åœ¨è¿è¡Œçš„`effect`ï¼‰ï¼Œåœ¨`set`çš„æ—¶å€™è§¦å‘æ›´æ–°ã€‚

### `ref`

å¯¹äºç®€å•æ•°æ®ç±»å‹æ¯”å¦‚`number`ï¼Œæˆ‘ä»¬ä¸å¯èƒ½åƒè¿™æ ·å»åšï¼š

```js
let data = reactive(2)
// ğŸ˜­oops
data = 5
```

è¿™æ˜¯ä¸ç¬¦åˆå“åº”å¼çš„æ‹¦æˆªè§„åˆ™çš„ï¼Œæ²¡æœ‰åŠæ³•èƒ½æ‹¦æˆªåˆ°`data`æœ¬èº«çš„æ”¹å˜ï¼Œåªèƒ½æ‹¦æˆªåˆ°`data`èº«ä¸Šçš„å±æ€§çš„æ”¹å˜ï¼Œæ‰€ä»¥æœ‰äº†`ref`ã€‚

```js
const data = ref(2)
// ğŸ’•ok
data.value= 5
```

### `computed`

è®¡ç®—å±æ€§ï¼Œä¾èµ–å€¼æ›´æ–°ä»¥åï¼Œå®ƒçš„å€¼ä¹Ÿä¼šéšä¹‹è‡ªåŠ¨æ›´æ–°ã€‚å…¶å®`computed`å†…éƒ¨ä¹Ÿæ˜¯ä¸€ä¸ª`effect`ã€‚

æ‹¥æœ‰åœ¨`computed`ä¸­è§‚å¯Ÿå¦ä¸€ä¸ª`computed`æ•°æ®ã€`effect`è§‚å¯Ÿ`computed`æ”¹å˜ä¹‹ç±»çš„é«˜çº§ç‰¹æ€§ã€‚

## å®ç°

ä»è¿™å‡ ä¸ªæ ¸å¿ƒ`api`æ¥çœ‹ï¼Œåªè¦`effect`èƒ½æ¥å…¥åˆ°`React`ç³»ç»Ÿä¸­ï¼Œé‚£ä¹ˆå…¶ä»–çš„`api`éƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸ºå®ƒä»¬åªæ˜¯å»æ”¶é›†`effect`çš„ä¾èµ–ï¼Œå»é€šçŸ¥`effect`è§¦å‘æ›´æ–°ã€‚

`effect`æ¥å—çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸”`effect`è¿˜æ”¯æŒé€šè¿‡ä¼ å…¥`schedule`å‚æ•°æ¥è‡ªå®šä¹‰ä¾èµ–æ›´æ–°çš„æ—¶å€™éœ€è¦è§¦å‘ä»€ä¹ˆå‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸ª`schedule`æ›¿æ¢æˆå¯¹åº”ç»„ä»¶çš„æ›´æ–°å‘¢ï¼Ÿè¦çŸ¥é“åœ¨`hook`çš„ä¸–ç•Œä¸­ï¼Œå®ç°å½“å‰ç»„ä»¶å¼ºåˆ¶æ›´æ–°å¯æ˜¯å¾ˆç®€å•çš„ï¼š

```js
useForceUpdate
export const useForceUpdate = () => {
  const [, forceUpdate] = useReducer(s => s + 1, 0);
  return forceUpdate;
};
```

è¿™æ˜¯ä¸€ä¸ªå¾ˆç»å…¸çš„è‡ªå®šä¹‰`hook`ï¼Œé€šè¿‡ä¸æ–­çš„æŠŠçŠ¶æ€`+1`æ¥å¼ºè¡Œè®©ç»„ä»¶æ¸²æŸ“ã€‚

è€Œ`rxv`çš„æ ¸å¿ƒ`api`: `useStore`æ¥å—çš„ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°`selector`ï¼Œå®ƒä¼šè®©ç”¨æˆ·è‡ªå·±é€‰æ‹©åœ¨ç»„ä»¶ä¸­éœ€è¦è®¿é—®çš„æ•°æ®ã€‚

é‚£ä¹ˆæ€è·¯å°±æ˜¾è€Œæ˜“è§äº†ï¼š

- æŠŠ`selector`åŒ…è£…åœ¨`effect`ä¸­æ‰§è¡Œï¼Œå»æ”¶é›†ä¾èµ–ã€‚
- æŒ‡å®šä¾èµ–å‘ç”Ÿæ›´æ–°æ—¶ï¼Œéœ€è¦è°ƒç”¨çš„å‡½æ•°æ˜¯å½“å‰æ­£åœ¨ä½¿ç”¨`useStore`çš„è¿™ä¸ªç»„ä»¶çš„`forceUpdate`å¼ºåˆ¶æ¸²æŸ“å‡½æ•°ã€‚

è¿™æ ·ä¸å°±å®ç°äº†æ•°æ®å˜åŒ–ï¼Œç»„ä»¶è‡ªåŠ¨æ›´æ–°å—ï¼Ÿ

ç®€å•çš„çœ‹ä¸€ä¸‹æ ¸å¿ƒå®ç°

```js
useStoreå’ŒProvider
import React, { useContext } from 'react';
import { useForceUpdate, useEffection } from './share';

type Selector<T, S> = (store: T) => S;

const StoreContext = React.createContext<any>(null);

const useStoreContext = () => {
  const contextValue = useContext(StoreContext);
  if (!contextValue) {
    throw new Error(
      'could not find store context value; please ensure the component is wrapped in a <Provider>',
    );
  }
  return contextValue;
};

/**
 * åœ¨ç»„ä»¶ä¸­è¯»å–å…¨å±€çŠ¶æ€
 * éœ€è¦é€šè¿‡ä¼ å…¥çš„å‡½æ•°æ”¶é›†ä¾èµ–
 */
export const useStore = <T, S>(selector: Selector<T, S>): S => {
  const forceUpdate = useForceUpdate();
  const store = useStoreContext();

  const effection = useEffection(() => selector(store), {
    scheduler: forceUpdate,
    lazy: true,
  });

  const value = effection();
  return value;
};

export const Provider = StoreContext.Provider;
```

è¿™ä¸ª`option`æ˜¯ä¼ é€’ç»™`Vue3`çš„`effectapi`ï¼Œ

`scheduler`è§„å®šå“åº”å¼æ•°æ®æ›´æ–°ä»¥ååº”è¯¥åšä»€ä¹ˆæ“ä½œï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨`forceUpdate`å»è®©ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚

`lazy`è¡¨ç¤ºå»¶è¿Ÿæ‰§è¡Œï¼Œåé¢æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨`effection`æ¥æ‰§è¡Œ

```js
{
  scheduler: forceUpdate,
  lazy: true,
}
```

å†æ¥çœ‹ä¸‹`useEffection`å’Œ`useForceUpdate`

```js
import { useEffect, useReducer, useRef } from 'react';
import { effect, stop, ReactiveEffect } from '@vue/reactivity';

export const useEffection = (...effectArgs: Parameters<typeof effect>) => {
  // ç”¨ä¸€ä¸ªrefå­˜å‚¨effection
  // effectå‡½æ•°åªéœ€è¦åˆå§‹åŒ–æ‰§è¡Œä¸€é
  const effectionRef = useRef<ReactiveEffect>();
  if (!effectionRef.current) {
    effectionRef.current = effect(...effectArgs);
  }

  // å¸è½½ç»„ä»¶åå–æ¶ˆeffect
  const stopEffect = () => {
    stop(effectionRef.current!);
  };
  useEffect(() => stopEffect, []);

  return effectionRef.current
};

export const useForceUpdate = () => {
  const [, forceUpdate] = useReducer(s => s + 1, 0);
  return forceUpdate;
};
```

ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠä¼ å…¥çš„å‡½æ•°äº¤ç»™`effect`ï¼Œå¹¶ä¸”åœ¨ç»„ä»¶é”€æ¯çš„æ—¶å€™åœæ­¢`effect`è€Œå·²ã€‚

## æµç¨‹

1. å…ˆé€šè¿‡`useForceUpdate`åœ¨å½“å‰ç»„ä»¶ä¸­æ³¨å†Œä¸€ä¸ªå¼ºåˆ¶æ›´æ–°çš„å‡½æ•°ã€‚
1. é€šè¿‡`useContext`è¯»å–ç”¨æˆ·ä»`Provider`ä¸­ä¼ å…¥çš„`store`ã€‚
1. å†é€šè¿‡`Vue`çš„`effect`å»å¸®æˆ‘ä»¬æ‰§è¡Œ`selector(store)`ï¼Œå¹¶ä¸”æŒ‡å®š`scheduler`ä¸º`forceUpdate`ï¼Œè¿™æ ·å°±å®Œæˆäº†ä¾èµ–æ”¶é›†ã€‚
1. é‚£ä¹ˆåœ¨`store`é‡Œçš„å€¼æ›´æ–°äº†ä»¥åï¼Œè§¦å‘äº†`scheduler`ä¹Ÿå°±æ˜¯`forceUpdate`ï¼Œæˆ‘ä»¬çš„`React`ç»„ä»¶å°±è‡ªåŠ¨æ›´æ–°å•¦ã€‚


å°±ç®€å•çš„å‡ è¡Œä»£ç ï¼Œå°±å®ç°äº†åœ¨`React`ä¸­ä½¿ç”¨`@vue/reactivity`ä¸­çš„æ‰€æœ‰èƒ½åŠ›ã€‚

- ä¼˜ç‚¹ï¼š
    - ç›´æ¥å¼•å…¥`@vue/reacivity`ï¼Œå®Œå…¨ä½¿ç”¨`Vue3`çš„`reactivity`èƒ½åŠ›ï¼Œæ‹¥æœ‰`computed`, `effect`ç­‰å„ç§èƒ½åŠ›ï¼Œå¹¶ä¸”å¯¹äº`Set`å’Œ`Map`ä¹Ÿæä¾›äº†å“åº”å¼çš„èƒ½åŠ›ã€‚åç»­ä¹Ÿä¼šéšç€è¿™ä¸ªåº“çš„æ›´æ–°å˜å¾—æ›´åŠ å®Œå–„çš„å’Œå¼ºå¤§ã€‚
    - `vue-next`ä»“åº“å†…éƒ¨å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ã€‚
    - å®Œå–„çš„`TypeScript`ç±»å‹æ”¯æŒã€‚
    - å®Œå…¨å¤ç”¨`@vue/reacivity`å®ç°è¶…å¼ºçš„å…¨å±€çŠ¶æ€ç®¡ç†èƒ½åŠ›ã€‚
    - çŠ¶æ€ç®¡ç†ä¸­ç»„ä»¶çº§åˆ«çš„ç²¾ç¡®æ›´æ–°ã€‚
    - `Vue3`æ€»æ˜¯è¦å­¦çš„å˜›ï¼Œæå‰å­¦ä¹ é˜²æ­¢å¤±ä¸šï¼

- ç¼ºç‚¹ï¼š

    ç”±äºéœ€è¦ç²¾ç¡®çš„æ”¶é›†ä¾èµ–å…¨é `useStore`ï¼Œæ‰€ä»¥`selector`å‡½æ•°ä¸€å®šè¦ç²¾ç¡®çš„è®¿é—®åˆ°ä½ å…³å¿ƒçš„æ•°æ®ã€‚ç”šè‡³å¦‚æœä½ éœ€è¦è§¦å‘æ•°ç»„å†…éƒ¨æŸä¸ªå€¼çš„æ›´æ–°ï¼Œé‚£ä½ åœ¨`useStore`ä¸­å°±ä¸èƒ½åªè¿”å›è¿™ä¸ªæ•°ç»„æœ¬èº«ã€‚

ä¸¾ä¸€ä¸ªä¾‹å­ï¼š

```js
function Logger() {
  const logs = useStore((store: Store) => {
    return store.state.logs.map((log, idx) => (
      <p className="log" key={idx}>
        {log}
      </p>
    ));
  });

  return (
    <Card hoverable>
      <h1>æ§åˆ¶å°</h1>
      <div className="logs">{logs}</div>
    </Card>
  );
}
```

è¿™æ®µä»£ç ç›´æ¥åœ¨`useStore`ä¸­è¿”å›äº†æ•´æ®µ`jsx`ï¼Œæ˜¯å› ä¸º`map`çš„è¿‡ç¨‹ä¸­å›å»è®¿é—®æ•°ç»„çš„æ¯ä¸€é¡¹æ¥æ”¶é›†ä¾èµ–ï¼Œåªæœ‰è¿™æ ·æ‰èƒ½è¾¾åˆ°å“åº”å¼çš„ç›®çš„ã€‚
